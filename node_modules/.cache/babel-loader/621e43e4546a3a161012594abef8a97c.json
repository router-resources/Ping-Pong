{"ast":null,"code":"import { isBrowser, getLocation, getQueryString, detectEnv, appendToQueryString } from \"@walletconnect/utils\";\nimport NetworkMonitor from \"./network\";\nconst WS = typeof global.WebSocket !== \"undefined\" ? global.WebSocket : require(\"ws\");\nclass SocketTransport {\n  constructor(opts) {\n    this.opts = opts;\n    this._queue = [];\n    this._events = [];\n    this._subscriptions = [];\n    this._protocol = opts.protocol;\n    this._version = opts.version;\n    this._url = \"\";\n    this._netMonitor = null;\n    this._socket = null;\n    this._nextSocket = null;\n    this._subscriptions = opts.subscriptions || [];\n    this._netMonitor = opts.netMonitor || new NetworkMonitor();\n    if (!opts.url || typeof opts.url !== \"string\") {\n      throw new Error(\"Missing or invalid WebSocket url\");\n    }\n    this._url = opts.url;\n    this._netMonitor.on(\"online\", () => this._socketCreate());\n  }\n  set readyState(value) {}\n  get readyState() {\n    return this._socket ? this._socket.readyState : -1;\n  }\n  set connecting(value) {}\n  get connecting() {\n    return this.readyState === 0;\n  }\n  set connected(value) {}\n  get connected() {\n    return this.readyState === 1;\n  }\n  set closing(value) {}\n  get closing() {\n    return this.readyState === 2;\n  }\n  set closed(value) {}\n  get closed() {\n    return this.readyState === 3;\n  }\n  open() {\n    this._socketCreate();\n  }\n  close() {\n    this._socketClose();\n  }\n  send(message, topic, silent) {\n    if (!topic || typeof topic !== \"string\") {\n      throw new Error(\"Missing or invalid topic field\");\n    }\n    this._socketSend({\n      topic: topic,\n      type: \"pub\",\n      payload: message,\n      silent: !!silent\n    });\n  }\n  subscribe(topic) {\n    this._socketSend({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    });\n  }\n  on(event, callback) {\n    this._events.push({\n      event,\n      callback\n    });\n  }\n  _socketCreate() {\n    if (this._nextSocket) {\n      return;\n    }\n    const url = getWebSocketUrl(this._url, this._protocol, this._version);\n    this._nextSocket = new WS(url);\n    if (!this._nextSocket) {\n      throw new Error(\"Failed to create socket\");\n    }\n    this._nextSocket.onmessage = event => this._socketReceive(event);\n    this._nextSocket.onopen = () => this._socketOpen();\n    this._nextSocket.onerror = event => this._socketError(event);\n    this._nextSocket.onclose = () => {\n      setTimeout(() => {\n        this._nextSocket = null;\n        this._socketCreate();\n      }, 1000);\n    };\n  }\n  _socketOpen() {\n    this._socketClose();\n    this._socket = this._nextSocket;\n    this._nextSocket = null;\n    this._queueSubscriptions();\n    this._pushQueue();\n  }\n  _socketClose() {\n    if (this._socket) {\n      this._socket.onclose = () => {};\n      this._socket.close();\n    }\n  }\n  _socketSend(socketMessage) {\n    const message = JSON.stringify(socketMessage);\n    if (this._socket && this._socket.readyState === 1) {\n      this._socket.send(message);\n    } else {\n      this._setToQueue(socketMessage);\n      this._socketCreate();\n    }\n  }\n  async _socketReceive(event) {\n    let socketMessage;\n    try {\n      socketMessage = JSON.parse(event.data);\n    } catch (error) {\n      return;\n    }\n    this._socketSend({\n      topic: socketMessage.topic,\n      type: \"ack\",\n      payload: \"\",\n      silent: true\n    });\n    if (this._socket && this._socket.readyState === 1) {\n      const events = this._events.filter(event => event.event === \"message\");\n      if (events && events.length) {\n        events.forEach(event => event.callback(socketMessage));\n      }\n    }\n  }\n  _socketError(e) {\n    const events = this._events.filter(event => event.event === \"error\");\n    if (events && events.length) {\n      events.forEach(event => event.callback(e));\n    }\n  }\n  _queueSubscriptions() {\n    const subscriptions = this._subscriptions;\n    subscriptions.forEach(topic => this._queue.push({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    }));\n    this._subscriptions = this.opts.subscriptions || [];\n  }\n  _setToQueue(socketMessage) {\n    this._queue.push(socketMessage);\n  }\n  _pushQueue() {\n    const queue = this._queue;\n    queue.forEach(socketMessage => this._socketSend(socketMessage));\n    this._queue = [];\n  }\n}\nfunction getWebSocketUrl(_url, protocol, version) {\n  var _a, _b;\n  const url = _url.startsWith(\"https\") ? _url.replace(\"https\", \"wss\") : _url.startsWith(\"http\") ? _url.replace(\"http\", \"ws\") : _url;\n  const splitUrl = url.split(\"?\");\n  const params = isBrowser() ? {\n    protocol,\n    version,\n    env: \"browser\",\n    host: ((_a = getLocation()) === null || _a === void 0 ? void 0 : _a.host) || \"\"\n  } : {\n    protocol,\n    version,\n    env: ((_b = detectEnv()) === null || _b === void 0 ? void 0 : _b.name) || \"\"\n  };\n  const queryString = appendToQueryString(getQueryString(splitUrl[1] || \"\"), params);\n  return splitUrl[0] + \"?\" + queryString;\n}\nexport default SocketTransport;","map":{"version":3,"mappings":"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","names":["isBrowser","getLocation","getQueryString","detectEnv","appendToQueryString","NetworkMonitor","WS","global","WebSocket","require","SocketTransport","constructor","opts","_protocol","protocol","_version","version","_url","_netMonitor","_socket","_nextSocket","_subscriptions","subscriptions","netMonitor","url","Error","on","_socketCreate","readyState","value","connecting","connected","closing","closed","open","close","_socketClose","send","message","topic","silent","_socketSend","type","payload","subscribe","event","callback","_events","push","getWebSocketUrl","onmessage","_socketReceive","onopen","_socketOpen","onerror","_socketError","onclose","setTimeout","_queueSubscriptions","_pushQueue","socketMessage","JSON","stringify","_setToQueue","parse","data","error","events","filter","length","forEach","e","_queue","queue","startsWith","replace","splitUrl","split","params","env","host","name","queryString"],"sourceRoot":"","sources":["../../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}