module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=18)}([function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("bn.js")},function(e,t){e.exports=require("@toruslabs/http-helpers")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("web3-utils")},function(e,t){e.exports=require("@babel/runtime/helpers/classCallCheck")},function(e,t){e.exports=require("@babel/runtime/helpers/createClass")},function(e,t){e.exports=require("@babel/runtime/helpers/getPrototypeOf")},function(e,t){e.exports=require("@toruslabs/eccrypto")},function(e,t){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,t){e.exports=require("json-stable-stringify")},function(e,t){e.exports=require("@babel/runtime/helpers/inherits")},function(e,t){e.exports=require("@babel/runtime/helpers/possibleConstructorReturn")},function(e,t){e.exports=require("@babel/runtime/helpers/wrapNativeSuper")},function(e,t){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,t){e.exports=require("@babel/runtime/helpers/typeof")},function(e,t){e.exports=require("elliptic")},function(e,t){e.exports=require("loglevel")},function(e,t,r){"use strict";r.r(t),r.d(t,"keyAssign",(function(){return L})),r.d(t,"keyLookup",(function(){return U})),r.d(t,"waitKeyLookup",(function(){return V}));var n=r(9),i=r.n(n),o=r(15),a=r.n(o),s=r(3),u=r.n(s),c=r(5),f=r.n(c),l=r(6),p=r.n(l),h=r(0),d=r.n(h),b=r(8),g=r(2),v=r(1),y=r.n(v),m=r(16),k=r(10),x=r.n(k),w=r(4),O=r(17),P=r.n(O).a.getLogger("torus.js");P.disableAll();var S=P,j=r(11),N=r.n(j),_=r(12),A=r.n(_),K=r(7),E=r.n(K),R=r(13),q=r.n(R);function H(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E()(e);if(t){var i=E()(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A()(this,r)}}var F=function(e){N()(r,e);var t=H(r);function r(e){var n,i=e.errors,o=e.responses,a=e.predicate;return f()(this,r),(n=t.call(this,"Unable to resolve enough promises.")).errors=i,n.responses=o,n.predicate=a,n}return p()(r)}(q()(Error)),I=function(e,t){return new Promise((function(r,n){var i,o=0,a={resolved:!1},s=new Array(e.length).fill(void 0),u=new Array(e.length).fill(void 0);e.forEach((function(c,f){c.then((function(e){u[f]=e})).catch((function(e){s[f]=e})).finally((function(){a.resolved||t(u.slice(0),a).then((function(e){a.resolved=!0,r(e)})).catch((function(e){i=e})).finally((function(t){if((o+=1)===e.length){var r=Object.values(u.reduce((function(e,t){var r,n,i=t||{},o=i.id,a=i.error;return(null==a||null===(r=a.data)||void 0===r?void 0:r.length)>0&&(a.data.startsWith("Error occurred while verifying params")?e[o]=(n=a.data).charAt(0).toUpperCase()+n.slice(1):e[o]=a.data),e}),{}));if(r.length>0){var a=r.length>1?"\n".concat(r.map((function(e){return"â€¢ ".concat(e)})).join("\n")):r[0];n(new Error(a))}else{var c;n(new F({errors:s,responses:u,predicate:(null===(c=i)||void 0===c?void 0:c.message)||i}))}}}))}))}))}))},M=r(14),J=r.n(M);function X(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?X(Object(r),!0).forEach((function(t){i()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):X(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function C(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E()(e);if(t){var i=E()(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A()(this,r)}}var B=function(e){N()(r,e);var t=C(r);function r(){return f()(this,r),t.apply(this,arguments)}return p()(r)}(q()(Error)),T=function e(t,r){var n=t;if("number"==typeof n&&(n=Array.from({length:n},(function(e,t){return t}))),r>n.length||r<=0)return[];if(r===n.length)return[n];if(1===r)return n.reduce((function(e,t){return[].concat(J()(e),[[t]])}),[]);for(var i=[],o=[],a=0;a<=n.length-r+1;a+=1){o=e(n.slice(a+1),r-1);for(var s=0;s<o.length;s+=1)i.push([n[a]].concat(J()(o[s])))}return i},D=function(e,t){for(var r={},n=0;n<e.length;n+=1){var i=x()(e[n]);if(r[i]=r[i]?r[i]+1:1,r[i]===t)return e[n]}},U=function(){var e=u()(d.a.mark((function e(t,r,n){var i;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.map((function(e){return Object(g.post)(e,Object(g.generateJsonRPCObject)("VerifierLookupRequest",{verifier:r,verifier_id:n.toString()})).catch((function(e){return S.error("lookup request failed",e)}))})),e.abrupt("return",I(i,(function(e){var r=e.filter((function(e){return e})),n=D(r.map((function(e){return e&&e.error})),1+~~(t.length/2)),i=D(r.map((function(e){return e&&e.result})),1+~~(t.length/2));return i||n?Promise.resolve({keyResult:i,errorResult:n}):Promise.reject(new Error("invalid results ".concat(JSON.stringify(e))))})));case 2:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),V=function(e,t,r,n){return new Promise((function(i,o){setTimeout((function(){U(e,t,r).then(i).catch(o)}),n)}))},L=function(){var e=u()(d.a.mark((function e(t){var r,n,i,o,a,s,u,c,f,l,p;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.endpoints,n=t.torusNodePubs,i=t.lastPoint,o=t.firstPoint,a=t.verifier,s=t.verifierId,u=t.signerHost,void 0===i?(c=Math.floor(Math.random()*r.length),f=c):c=i%r.length,c!==o){e.next=4;break}throw new Error("Looped through all");case 4:return void 0!==o&&(f=o),l=Object(g.generateJsonRPCObject)("KeyAssign",{verifier:a,verifier_id:s.toString()}),e.prev=6,e.next=9,Object(g.post)(u,l,{headers:{pubKeyX:n[c].X,pubKeyY:n[c].Y}},{useAPIKey:!0});case 9:return p=e.sent,e.abrupt("return",Object(g.post)(r[c],Y(Y({},l),p),{headers:{"Content-Type":"application/json; charset=utf-8"}}));case 13:if(e.prev=13,e.t0=e.catch(6),S.error(e.t0),!["Timed out","TypeError: Failed to fetch","TypeError: cancelled","TypeError: NetworkError when attempting to fetch resource."].includes(e.t0.message)){e.next=19;break}return e.abrupt("return",L({endpoints:r,torusNodePubs:n,lastPoint:c+1,firstPoint:f,verifier:a,verifierId:s,signerHost:u}));case 19:throw new Error("Sorry, the Torus Network that powers Web3Auth is currently very busy.\n    We will generate your key in time. Pls try again later. \n\n    ".concat(e.t0.message||""));case 20:case"end":return e.stop()}}),e,null,[[6,13]])})));return function(t){return e.apply(this,arguments)}}();function W(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function G(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?W(Object(r),!0).forEach((function(t){i()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):W(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var z=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.enableOneKey,n=void 0!==r&&r,i=t.metadataHost,o=void 0===i?"https://metadata.tor.us":i,a=t.allowHost,s=void 0===a?"https://signer.tor.us/api/allow":a,u=t.signerHost,c=void 0===u?"https://signer.tor.us/api/sign":u,l=t.serverTimeOffset,p=void 0===l?0:l;f()(this,e),this.ec=new m.ec("secp256k1"),this.metadataHost=o,this.allowHost=s,this.enableOneKey=n,this.serverTimeOffset=p||0,this.signerHost=c}var t,r,n,i,o,s,c,l;return p()(e,[{key:"getUserTypeAndAddress",value:(l=u()(d.a.mark((function e(t,r,n){var i,o,a,s,u,c,f,l,p,h,b,g,v,m,k,x,w,O,P,S,j,N=arguments;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.verifier,o=n.verifierId,a=N.length>3&&void 0!==N[3]&&N[3],e.next=4,U(t,i,o);case 4:if(e.t0=e.sent,e.t0){e.next=7;break}e.t0={};case 7:if(s=e.t0,u=s.keyResult,c=s.errorResult,f=!1,!c||!JSON.stringify(c).includes("Verifier + VerifierID has not yet been assigned")){e.next=26;break}if(a){e.next=14;break}throw new Error("Verifier + VerifierID has not yet been assigned");case 14:return e.next=16,L({endpoints:t,torusNodePubs:r,lastPoint:void 0,firstPoint:void 0,verifier:i,verifierId:o,signerHost:this.signerHost});case 16:return e.next=18,V(t,i,o,1e3);case 18:if(e.t1=e.sent,e.t1){e.next=21;break}e.t1={};case 21:p=e.t1,l=p.keyResult,f=!0,e.next=31;break;case 26:if(!u){e.next=30;break}l=u,e.next=31;break;case 30:throw new Error("node results do not match at first lookup ".concat(JSON.stringify(u||{}),", ").concat(JSON.stringify(c||{})));case 31:if(!l){e.next=61;break}return h=l.keys[0],b=h.pub_key_X,g=h.pub_key_Y,e.prev=33,e.next=37,this.getOrSetNonce(b,g,void 0,!f);case 37:O=e.sent,v=O.typeOfUser,m=O.nonce,k=O.pubNonce,w=O.upgraded,m=new y.a(m||"0",16),e.next=48;break;case 45:throw e.prev=45,e.t2=e.catch(33),new B;case 48:if("v1"!==v){e.next=52;break}x=this.ec.keyFromPublic({x:b.toString(16),y:g.toString(16)}).getPublic().add(this.ec.keyFromPrivate(m.toString(16)).getPublic()),e.next=57;break;case 52:if("v2"!==v){e.next=56;break}x=this.ec.keyFromPublic({x:b.toString(16),y:g.toString(16)}).getPublic().add(this.ec.keyFromPublic({x:k.x,y:k.y}).getPublic()),e.next=57;break;case 56:throw new Error("getOrSetNonce should always return typeOfUser.");case 57:return P=x.getX().toString(16),S=x.getY().toString(16),j=this.generateAddressFromPubKey(x.getX(),x.getY()),e.abrupt("return",{typeOfUser:v,nonce:m,pubNonce:k,upgraded:w,X:P,Y:S,address:j});case 61:throw new Error("node results do not match at final lookup ".concat(JSON.stringify(u||{}),", ").concat(JSON.stringify(c||{})));case 62:case"end":return e.stop()}}),e,this,[[33,45]])}))),function(e,t,r){return l.apply(this,arguments)})},{key:"setCustomKey",value:(c=u()(d.a.mark((function e(t){var r,n,i,o,a,s,u,c,f;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.privKeyHex,n=t.metadataNonce,i=t.torusKeyHex,o=t.customKeyHex,i?a=new y.a(i,16):(s=new y.a(r,16),a=s.sub(n).umod(this.ec.curve.n)),u=new y.a(o,16),c=u.sub(a).umod(this.ec.curve.n),f=this.generateMetadataParams(c.toString(16),a.toString(16)),e.next=7,this.setMetadata(f);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"retrieveShares",value:(s=u()(d.a.mark((function e(t,r,n,i,o){var s,c,f,l,p,h,v,m,k,x=this,O=arguments;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=O.length>5&&void 0!==O[5]?O[5]:{},c=[],e.next=4,Object(g.get)(this.allowHost,{headers:{verifier:n,verifier_id:i.verifier_id}},{useAPIKey:!0});case 4:for(f=Object(b.generatePrivate)(),l=Object(b.getPublic)(f).toString("hex"),p=l.slice(2,66),h=l.slice(66),v=Object(w.keccak256)(o),m=0;m<t.length;m+=1)k=Object(g.post)(t[m],Object(g.generateJsonRPCObject)("CommitmentRequest",{messageprefix:"mug00",tokencommitment:v.slice(2),temppubx:p,temppuby:h,verifieridentifier:n})).catch((function(e){return S.error("commitment",e)})),c.push(k);return e.abrupt("return",I(c,(function(e){return e.filter((function(e){return!(!e||"object"!==a()(e)||e.error)})).length>=3*~~(t.length/4)+1?Promise.resolve(e):Promise.reject(new Error("invalid ".concat(JSON.stringify(e))))})).then((function(e){for(var a=[],c=[],l=0;l<e.length;l+=1)e[l]&&c.push(e[l].result);for(var p=0;p<t.length;p+=1){var h=Object(g.post)(t[p],Object(g.generateJsonRPCObject)("ShareRequest",{encrypted:"yes",item:[G(G({},i),{},{idtoken:o,nodesignatures:c,verifieridentifier:n},s)]})).catch((function(e){return S.error("share req",e)}));a.push(h)}return I(a,function(){var e=u()(d.a.mark((function e(n,i){var o,a,s,u,c,l,p,h,g,v,m,k;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=n.filter((function(e){return e})),a=D(n.map((function(e){return e&&e.result&&e.result.keys[0].PublicKey})),1+~~(t.length/2)),!(o.length>=1+~~(t.length/2)&&a)){e.next=25;break}for(s=[],u=[],c=0;c<n.length;c+=1)n[c]&&n[c].result&&n[c].result.keys&&n[c].result.keys.length>0?(n[c].result.keys.sort((function(e,t){return new y.a(e.Index,16).cmp(new y.a(t.Index,16))})),n[c].result.keys[0].Metadata?(l={ephemPublicKey:Buffer.from(n[c].result.keys[0].Metadata.ephemPublicKey,"hex"),iv:Buffer.from(n[c].result.keys[0].Metadata.iv,"hex"),mac:Buffer.from(n[c].result.keys[0].Metadata.mac,"hex"),mode:Buffer.from(n[c].result.keys[0].Metadata.mode,"hex")},s.push(Object(b.decrypt)(f,G(G({},l),{},{ciphertext:Buffer.from(atob(n[c].result.keys[0].Share).padStart(64,"0"),"hex")})).catch((function(e){return S.debug("share decryption",e)})))):s.push(Promise.resolve(Buffer.from(n[c].result.keys[0].Share.padStart(64,"0"),"hex")))):s.push(Promise.resolve(void 0)),u.push(new y.a(r[c],16));return e.next=8,Promise.all(s);case 8:if(p=e.sent,!i.resolved){e.next=11;break}return e.abrupt("return",void 0);case 11:h=p.reduce((function(e,t,r){return t&&e.push({index:u[r],value:new y.a(t)}),e}),[]),g=T(h.length,1+~~(t.length/2)),m=function(e){var t=g[e],r=h.filter((function(e,r){return t.includes(r)})),n=r.map((function(e){return e.value})),i=r.map((function(e){return e.index})),o=x.lagrangeInterpolation(n,i),s=Object(b.getPublic)(Buffer.from(o.toString(16,64),"hex")).toString("hex"),u=s.slice(2,66),c=s.slice(66);if(0===new y.a(u,16).cmp(new y.a(a.X,16))&&0===new y.a(c,16).cmp(new y.a(a.Y,16)))return v=o,"break"},k=0;case 15:if(!(k<g.length)){e.next=22;break}if("break"!==m(k)){e.next=19;break}return e.abrupt("break",22);case 19:k+=1,e.next=15;break;case 22:if(void 0!==v){e.next=24;break}throw new Error("could not derive private key");case 24:return e.abrupt("return",v);case 25:throw new Error("invalid");case 26:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}())})).then(function(){var e=u()(d.a.mark((function e(t){var r,n,i,o,a,s,u,c;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t,n=Object(b.getPublic)(Buffer.from(r.toString(16,64),"hex")).toString("hex"),i=n.slice(2,66),o=n.slice(66),!x.enableOneKey){e.next=12;break}return e.next=7,x.getNonce(i,o,r);case 7:s=e.sent,u=s.nonce,a=new y.a(u||"0",16),e.next=15;break;case 12:return e.next=14,x.getMetadata({pub_key_X:i,pub_key_Y:o});case 14:a=e.sent;case 15:return S.debug("> torus.js/retrieveShares",{privKey:r.toString(16),metadataNonce:a.toString(16)}),r=r.add(a).umod(x.ec.curve.n),c=x.generateAddressFromPrivKey(r),S.debug("> torus.js/retrieveShares",{ethAddress:c,privKey:r.toString(16)}),e.abrupt("return",{ethAddress:c,privKey:r.toString("hex",64),metadataNonce:a});case 20:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,i){return s.apply(this,arguments)})},{key:"getMetadata",value:(o=u()(d.a.mark((function e(t,r){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(g.post)("".concat(this.metadataHost,"/get"),t,r,{useAPIKey:!0});case 3:if((n=e.sent)&&n.message){e.next=6;break}return e.abrupt("return",new y.a(0));case 6:return e.abrupt("return",new y.a(n.message,16));case 9:return e.prev=9,e.t0=e.catch(0),S.error("get metadata error",e.t0),e.abrupt("return",new y.a(0));case 13:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e,t){return o.apply(this,arguments)})},{key:"generateMetadataParams",value:function(e,t){var r=this.ec.keyFromPrivate(t.toString("hex",64)),n={data:e,timestamp:new y.a(~~(this.serverTimeOffset+Date.now()/1e3)).toString(16)},i=r.sign(Object(w.keccak256)(x()(n)).slice(2));return{pub_key_X:r.getPublic().getX().toString("hex"),pub_key_Y:r.getPublic().getY().toString("hex"),set_data:n,signature:Buffer.from(i.r.toString(16,64)+i.s.toString(16,64)+new y.a(i.v).toString(16,2),"hex").toString("base64")}}},{key:"setMetadata",value:(i=u()(d.a.mark((function e(t,r){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(g.post)("".concat(this.metadataHost,"/set"),t,r,{useAPIKey:!0});case 3:return n=e.sent,e.abrupt("return",n.message);case 7:return e.prev=7,e.t0=e.catch(0),S.error("set metadata error",e.t0),e.abrupt("return","");case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e,t){return i.apply(this,arguments)})},{key:"lagrangeInterpolation",value:function(e,t){if(e.length!==t.length)return null;for(var r=new y.a(0),n=0;n<e.length;n+=1){for(var i=new y.a(1),o=new y.a(1),a=0;a<e.length;a+=1)if(n!==a){i=(i=i.mul(t[a].neg())).umod(this.ec.curve.n);var s=t[n].sub(t[a]);s=s.umod(this.ec.curve.n),o=o.mul(s).umod(this.ec.curve.n)}var u=i.mul(o.invm(this.ec.curve.n)).umod(this.ec.curve.n);u=u.mul(e[n]).umod(this.ec.curve.n),r=r.add(u)}return r.umod(this.ec.curve.n)}},{key:"generateAddressFromPrivKey",value:function(e){var t=this.ec.keyFromPrivate(e.toString("hex",64),"hex").getPublic().encode("hex").slice(2),r="0x".concat(Object(w.keccak256)(Buffer.from(t,"hex")).slice(26));return Object(w.toChecksumAddress)(r)}},{key:"generateAddressFromPubKey",value:function(e,t){var r=this.ec.keyFromPublic({x:e.toString("hex",64),y:t.toString("hex",64)}).getPublic().encode("hex").slice(2),n="0x".concat(Object(w.keccak256)(Buffer.from(r,"hex")).slice(26));return Object(w.toChecksumAddress)(n)}},{key:"getPublicAddress",value:(n=u()(d.a.mark((function e(t,r,n){var i,o,a,s,u,c,f,l,p,h,b,g,v,m,k,x,w,O,P,j,N=arguments;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.verifier,o=n.verifierId,a=N.length>3&&void 0!==N[3]&&N[3],S.debug("> torus.js/getPublicAddress",{endpoints:t,torusNodePubs:r,verifier:i,verifierId:o,isExtended:a}),u=!1,e.next=6,U(t,i,o);case 6:if(e.t0=e.sent,e.t0){e.next=9;break}e.t0={};case 9:if(c=e.t0,f=c.keyResult,!(l=c.errorResult)||!JSON.stringify(l).includes("Verifier not supported")){e.next=16;break}throw new Error("Verifier not supported. Check if you: \n\n      1. Are on the right network (Torus testnet/mainnet) \n\n      2. Have setup a verifier on dashboard.web3auth.io?");case 16:if(!l||!JSON.stringify(l).includes("Verifier + VerifierID has not yet been assigned")){e.next=29;break}return e.next=19,L({endpoints:t,torusNodePubs:r,lastPoint:void 0,firstPoint:void 0,verifier:i,verifierId:o,signerHost:this.signerHost});case 19:return e.next=21,V(t,i,o,1e3);case 21:if(e.t1=e.sent,e.t1){e.next=24;break}e.t1={};case 24:p=e.t1,s=p.keyResult,u=!0,e.next=34;break;case 29:if(!f){e.next=33;break}s=f,e.next=34;break;case 33:throw new Error("node results do not match at first lookup ".concat(JSON.stringify(f||{}),", ").concat(JSON.stringify(l||{})));case 34:if(S.debug("> torus.js/getPublicAddress",{finalKeyResult:s,isNewKey:u}),!s){e.next=76;break}if(b=s.keys[0],g=b.pub_key_X,v=b.pub_key_Y,!this.enableOneKey){e.next=64;break}return e.prev=38,e.next=42,this.getOrSetNonce(g,v,void 0,!u);case 42:P=e.sent,m=P.typeOfUser,k=P.nonce,x=P.pubNonce,O=P.upgraded,k=new y.a(k||"0",16),e.next=53;break;case 50:throw e.prev=50,e.t2=e.catch(38),new B;case 53:if("v1"!==m){e.next=57;break}w=this.ec.keyFromPublic({x:g.toString(16),y:v.toString(16)}).getPublic().add(this.ec.keyFromPrivate(k.toString(16)).getPublic()),e.next=62;break;case 57:if("v2"!==m){e.next=61;break}w=O?this.ec.keyFromPublic({x:g.toString(16),y:v.toString(16)}).getPublic():this.ec.keyFromPublic({x:g.toString(16),y:v.toString(16)}).getPublic().add(this.ec.keyFromPublic({x:x.x,y:x.y}).getPublic()),e.next=62;break;case 61:throw new Error("getOrSetNonce should always return typeOfUser.");case 62:e.next=69;break;case 64:return m="v1",e.next=67,this.getMetadata({pub_key_X:g,pub_key_Y:v});case 67:k=e.sent,w=this.ec.keyFromPublic({x:g.toString(16),y:v.toString(16)}).getPublic().add(this.ec.keyFromPrivate(k.toString(16)).getPublic());case 69:if(g=w.getX().toString(16),v=w.getY().toString(16),j=this.generateAddressFromPubKey(w.getX(),w.getY()),S.debug("> torus.js/getPublicAddress",{X:g,Y:v,address:j,typeOfUser:m,nonce:null===(h=k)||void 0===h?void 0:h.toString(16),pubNonce:x}),a){e.next=75;break}return e.abrupt("return",j);case 75:return e.abrupt("return",{typeOfUser:m,address:j,X:g,Y:v,metadataNonce:k,pubNonce:x});case 76:throw new Error("node results do not match at final lookup ".concat(JSON.stringify(f||{}),", ").concat(JSON.stringify(l||{})));case 77:case"end":return e.stop()}}),e,this,[[38,50]])}))),function(e,t,r){return n.apply(this,arguments)})},{key:"getOrSetNonce",value:(r=u()(d.a.mark((function e(t,r,n){var i,o,a,s=arguments;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=s.length>3&&void 0!==s[3]&&s[3],a=i?"getNonce":"getOrSetNonce",o=n?this.generateMetadataParams(a,n):{pub_key_X:t,pub_key_Y:r,set_data:{data:a}},e.abrupt("return",Object(g.post)("".concat(this.metadataHost,"/get_or_set_nonce"),o,void 0,{useAPIKey:!0}));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"getNonce",value:(t=u()(d.a.mark((function e(t,r,n){return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.getOrSetNonce(t,r,n,!0));case 1:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"getPostboxKeyFrom1OutOf1",value:function(e,t){var r=new y.a(e,16),n=new y.a(t,16);return r.sub(n).umod(this.ec.curve.n).toString("hex")}}],[{key:"enableLogging",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e?S.enableAll():S.disableAll()}},{key:"setAPIKey",value:function(e){Object(g.setAPIKey)(e)}},{key:"setEmbedHost",value:function(e){Object(g.setEmbedHost)(e)}},{key:"isGetOrSetNonceError",value:function(e){return e instanceof B}}]),e}();t.default=z}]);
//# sourceMappingURL=torusUtils.cjs.js.map